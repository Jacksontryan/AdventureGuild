package project.People;

import java.util.ArrayList;
import java.util.Random;

public class Person implements Ageable{

    private String name;

    private Race race;

    private DNA dna;

    private Sex sex;

    private int age;

    private Person partner;
    public Person fatherOfCurrentChild;

    private ArrayList<Person> children;

    private ArrayList<Person> newKids =  new ArrayList<>();

    private Person mother;
    private Person father;

    private int weeksPregnant;

    private boolean alive;
    private Job job;

    private House house;

    private int numMoney;

    private int lastAte;

    private static final ArrayList<Job> jobs = Job.instantiateJobs();

    public Person() {

        this.name = "TEMP";

        ArrayList<Race> races = Race.instantiateRaces();

        Random rand = new Random();

        this.race = races.get(rand.nextInt(races.size()));

        dna = new DNA(this.race.getRaceNum());

        sex = rand.nextInt(2) == 0 ? Sex.Female : Sex.Male;

        age = 0;

        partner = null;
        fatherOfCurrentChild = null;

        children = new ArrayList<Person>();

        mother = null;
        father = null;

        weeksPregnant = -1;

        alive = true;

        house = null;

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public Person(String name){

        this.name = name;

        ArrayList<Race> races = Race.instantiateRaces();

        Random rand = new Random();

        this.race = races.get(rand.nextInt(races.size()));

        dna = new DNA(this.race.getRaceNum());

        sex = rand.nextInt(2) == 0 ? Sex.Female : Sex.Male;

        age = 0;

        partner = null;
        fatherOfCurrentChild = null;

        children = new ArrayList<Person>();

        mother = null;
        father = null;

        weeksPregnant = -1;

        alive = true;

        house = null;

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public Person(String name, Race race){

        this.name = name;

        this.race = race;

        this.dna = new DNA(this.race.getRaceNum());

        Random rand = new Random();

        sex = rand.nextInt(2) == 0 ? Sex.Female : Sex.Male;

        age = rand.nextInt(race.getAverageLifespan());

        partner = null;
        fatherOfCurrentChild = null;

        children = new ArrayList<Person>();

        mother = null;
        father = null;

        weeksPregnant = -1;

        alive = true;

        house = null;

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public Person(String name, Race race, DNA dna){
        this.name = name;

        this.race = race;

        this.dna = dna;

        Random rand = new Random();

        this.sex = rand.nextInt(2) == 0 ? Sex.Female : Sex.Male;

        this.age = 0;

        partner = null;

        children = new ArrayList<Person>();

        mother = null;
        father = null;

        weeksPregnant = -1;

        alive = true;

        house = null;

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public Person(String name, Race race, DNA dna, Sex sex, int age){
        this.name = name;

        this.race = race;

        this.dna = dna;

        this.sex = sex;

        this.age = age;

        this.partner = null;

        this.children = new ArrayList<Person>();

        this.mother = null;
        this.father = null;

        this.weeksPregnant = -1;

        this.alive = true;

        house = null;

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public Person(String name, Person mother, Person father){

        if(mother.sex != Sex.Female || father.sex != Sex.Male || father.race != mother.race){
            throw new IllegalArgumentException();
        }

        this.name = name;

        this.race = mother.race;

        this.dna = father.dna.reproduce(mother.dna);

        Random rand = new Random();

        this.sex = rand.nextInt(2) == 0 ? Sex.Female : Sex.Male;

        this.age = 0;

        this.partner = null;

        this.children = new ArrayList<Person>();

        this.mother = mother;
        this.father = father;

        weeksPregnant = -1;

        alive = true;

        if(father.isHoused()){
            this.house = father.house;
        }else if(mother.isHoused()){
            this.house = mother.house;
        }else{
            this.house = null;
        }

        this.numMoney = 0;

        this.lastAte = 0;

        this.job = jobs.getLast();

    }

    public String getName(){
        return this.name;
    }

    public void rename(String name){
        this.name = name;
    }

    public Race getRace(){
        return this.race;
    }

    public Person getFather() {
        return father;
    }

    public Person getMother() {
        return mother;
    }

    public boolean isChild(){
        return this.getAge() < this.race.getReproductionAge();
    }

    public boolean isAdult(){
        return this.age >= this.race.getReproductionAge() && this.age < this.race.getAverageLifespan();
    }

    public boolean isElderly(){
        return this.age >= this.race.getAverageLifespan();
    }

    public DNA getDna(){
        return this.dna;
    }

    public Sex getSex(){
        return this.sex;
    }

    public int getAge(){
        return this.age;
    }

    public int getAgeInYears(){
        return this.age / 52;
    }

    public void age(){

        newKids.clear();

        this.age++;
        this.lastAte++;

        Random rand = new Random();
        int mutationChance = rand.nextInt(10000);
        if(mutationChance == 0){
            this.dna.mutate();
        }

        if(isPregnant()){

            weeksPregnant++;

            if(weeksPregnant >= race.getGestationPeriod()){
                newKids.add(giveBirth());
            }

        }

        //return null;

    }

    @Override
    public void ageYear() {
        for(int i = 0; i < 52; i++){
            this.age();
        }
    }

    public ArrayList<Person> getNewKids(){
        return this.newKids;
    }

    public Person getPartner(){
        return this.partner;
    }

    public boolean isMarried(){
        return this.partner != null;
    }

    public boolean getMarried(Person partner){
        if(this.partner == null && partner.partner == null && this.race.equals(partner.getRace()) && this.age >= this.race.getReproductionAge() && partner.age >= this.race.getReproductionAge()){

            if(partner.dna.getPercentageShared(this.dna) >= .125){
                return false;
            }

            this.partner = partner;
            partner.partner = this;

            return true;
        }
        return false;
    }

    public ArrayList<Person> getChildren(){
        return this.children;
    }

    public boolean hasChildren(){
        return !this.children.isEmpty();
    }

    public int getNumberOfChildren(){
        return this.children.size();
    }

    public Person getOldestChild(){

        int oldest = -1;
        Person oldestChild = null;

        for(Person child : this.children){
            if(child.getAge() > oldest){
                oldest = child.getAge();
                oldestChild = child;
            }
        }

        return oldestChild;

    }

    public void addChild(Person child){
        this.children.add(child);
    }

    public boolean isPregnant(){
        return weeksPregnant > -1;
    }

    public boolean getPregnant(){

        if(this.sex == Sex.Male || this.partner == null || this.partner.sex == Sex.Female || weeksPregnant >= 0 || !this.alive || !this.partner.alive){
            return false;
        }

        double agePercent = this.age / this.race.getAverageLifespan();
        double pregnantChance = Math.random();

        if(pregnantChance > agePercent){

            weeksPregnant = 0;
            fatherOfCurrentChild = partner;
            return true;

        }

        return false;

    }

    public Person giveBirth(){

        Person baby = new Person("TEMP", this, this.fatherOfCurrentChild);

        this.addChild(baby);
        fatherOfCurrentChild.addChild(baby);

        if(isHoused()){
            baby.house = this.house;
            house.addChildOccupant(baby);
        }

        fatherOfCurrentChild = null;
        weeksPregnant = -1;

        return baby;
    }

    public boolean isAlive(){
        return alive;
    }

    public void die(){

        if(partner != null){
            this.partner.makeMoney(this.numMoney);
            this.numMoney = 0;
            this.partner.partner = null;
            this.partner = null;
        }

        else if(!getChildren().isEmpty()){
            int moneyPerChild = numMoney / getChildren().size();
            for(int i = 0; i < getChildren().size(); i++){
                getChildren().get(i).makeMoney(moneyPerChild);
            }
            int extraMoney = numMoney - moneyPerChild * getChildren().size();
            children.getFirst().makeMoney(extraMoney);
            this.numMoney = 0;
        }

        if(father != null){
            this.father.children.remove(this);
        }
        if(mother != null){
            this.mother.children.remove(this);
        }

        alive = false;

    }

    public boolean hasJob(){
        return !this.job.equals(jobs.getLast());
    }

    public Job getJob(){
        return this.job;
    }

    public boolean hire(Job job){
        if(!this.job.equals(jobs.getLast()) || job.equals(jobs.getLast())){
            return false;
        }
        this.job = job;
        return true;
    }

    public void fire(){
        this.job = jobs.getLast();
    }

    public boolean isWorking(){
        return !this.job.equals(jobs.getLast()) && this.age < this.race.getAverageLifespan() && this.age >= this.race.getReproductionAge();
    }

    public boolean isHoused(){
        return house != null;
    }

    public House getHouse(){
        return house;
    }

    public boolean occupyHouse(House house){
        if(this.house == null){
            this.house = house;
            return true;
        }
        return false;
    }

    public boolean loseHouse(){
        if(this.house == null){
            return false;
        }
        this.house = null;
        return true;
    }

    public void makeMoney(int money){
        if(money > 0){
            this.numMoney += money;
        }
    }

    public int getLastAte(){
        return this.lastAte;
    }

    public void eat(){
        this.lastAte = 0;
    }

    public boolean canAfford(int cost){
        if(numMoney >= cost){
            return true;
        }
        return false;
    }

    public boolean spendMoney(int money){
        if(money > 0 && canAfford(money)){
            this.numMoney -= money;
            return true;
        }
        return false;
    }

    public int getMoney(){
        return this.numMoney;
    }

    @Override
    public boolean equals(Object person){

        if(this == person){
            return true;
        }

        if(!(person instanceof Person)){
            return false;
        }

        return this.getName().equals(((Person)person).getName()) && this.dna.equals(((Person)person).getDna());
    }

}
